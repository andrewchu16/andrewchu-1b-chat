{% extends "base.html" %}

{% block title %}Q{{ idx }} of {{ total }} - Data Generator{% endblock %}

{% block extra_styles %}
.textarea-large { height: 200px; min-height: 150px; resize: vertical; }
.textarea-small { height: 100px; min-height: 80px; resize: vertical; }
.split-form { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
.form-section { padding: 1.5rem; border: 1px solid #e2e8f0; border-radius: 12px; }
.form-section h3 { margin-top: 0; margin-bottom: 1rem; }
.form-section.question-section { background: #fefce8; border-color: #fbbf24; }
.form-section.answer-section { background: #f0f9ff; border-color: #0ea5e9; }

/* Subtle highlighting for active question */
.question-link.active { 
  background: #f8fafc; 
  color: #1f2937; 
  border: 1px solid #d1d5db;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}
.question-link.active .question-preview { 
  color: #4b5563; 
}

/* Filter controls */
.filter-controls {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 0.75rem;
  margin-bottom: 1rem;
}
.filter-toggle {
  display: flex;
  align-items: center;
  cursor: pointer;
  font-size: 0.875rem;
}
.filter-toggle input[type="checkbox"] {
  margin-right: 0.5rem;
}
.filter-label {
  color: #374151;
}

/* Hidden questions */
.question-item.hidden {
  display: none;
}
{% endblock %}

{% block layout %}
<div class="layout">
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Questions ({{ total }})</h3>

      <div class="progress-indicator">
        <div class="progress-text">{{ answered_count }} of {{ total }} answered</div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: {{ progress_percentage }}%"></div>
        </div>
      </div>

      <div class="filter-controls">
        <label class="filter-toggle">
          <input type="checkbox" id="hideAnswered" onchange="toggleAnsweredQuestions()">
          <span class="filter-label">Hide answered questions</span>
        </label>
      </div>
    </div>

    <div class="sidebar-content">
      <ul class="question-list">
        {% for question_item in questions_data %}
        <li class="question-item">
          <a href="/edit/{{ question_item.index }}" 
             class="question-link {% if question_item.index == current_index %}active{% endif %} {% if question_item.answered %}answered{% endif %}">
            <div class="question-number">Q{{ question_item.index + 1 }}</div>
            <div class="question-preview">{{ question_item.preview }}</div>
            {% if question_item.answered %}
              <span class="status-badge status-answered">Answered</span>
            {% else %}
              <span class="status-badge status-unanswered">Not Answered</span>
            {% endif %}
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>

    <div class="sidebar-footer">
      <a href="/manage" class="btn small secondary">Manage Questions</a>
      <a href="/download" class="btn small secondary">Download JSONL</a>
    </div>
  </div>
  <div class="main-content">
  <div class="meta">
    Question {{ idx }} of {{ total }}
    <span class="status-badge {{ status_class }}">{{ status_text }}</span>
  </div>
  
  <div class="split-form">
    <!-- Question Display Section -->
    <div class="form-section question-section">
      <h3>üìù Question</h3>
      <div class="question-display">
        <p><strong>{{ question }}</strong></p>
        <div class="actions">
          <button class="btn secondary" type="button" onclick="toggleQuestionEdit()">Edit Question</button>
        </div>
      </div>
      
      <!-- Hidden Question Editing Section -->
      <div class="question-edit-form" id="question-edit-form" style="display: none;">
        <form method="post" action="/update-question/{{ i }}" id="question-form">
          <label for="question"><strong>Question Text</strong></label><br/>
          <textarea id="question" name="question" class="textarea-small" required>{{ question }}</textarea>
          <div class="actions">
            <button class="btn" type="submit">Update Question</button>
            <button class="btn secondary" type="button" onclick="toggleQuestionEdit()">Cancel</button>
            <a class="btn danger" href="/delete-question/{{ i }}" 
               onclick="return confirm('Are you sure you want to delete this question?')">Delete</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Answer Editing Section -->
    <div class="form-section answer-section">
      <h3>üí¨ Your Answer{{ edit_label }}</h3>
      <form method="post" action="/update-answer/{{ i }}" id="answer-form">
        <label for="response"><strong>Response</strong></label><br/>
        <textarea id="response" name="response" class="textarea-large" required 
                  placeholder="Type your response here. Press Ctrl+Enter (or Cmd+Enter on Mac) to submit and go to next unanswered question.">{{ existing_answer }}</textarea>
        <div class="hint">Tip: Press Ctrl+Enter (or Cmd+Enter on Mac) to save and jump to the next unanswered question.</div>
        <div class="actions">
          <button class="btn" type="submit">{{ save_button_text }}</button>
          {% if existing_answer %}
          <button class="btn secondary" type="button" onclick="clearAnswer()">Clear Answer</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <div class="actions" style="margin-top: 2rem; justify-content: center;">
    {% if i > 0 %}
    <a class="btn secondary" href="/edit/{{ i - 1 }}">‚Üê Previous</a>
    {% endif %}
    {% if i < total - 1 %}
    <a class="btn secondary" href="/edit/{{ i + 1 }}">Next ‚Üí</a>
    {% endif %}
  </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Keyboard shortcuts
  document.getElementById('response').addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      // Change form action to navigate to next unanswered question
      const form = document.getElementById('answer-form');
      form.action = '/update-answer-next-unanswered/{{ i }}';
      form.submit();
    }
  });

  // Navigation shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.altKey) {
      if (e.key === 'ArrowLeft' && {{ i }} > 0) {
        window.location.href = '/edit/{{ i - 1 }}';
      } else if (e.key === 'ArrowRight' && {{ i }} < {{ total - 1 }}) {
        window.location.href = '/edit/{{ i + 1 }}';
      }
    }
  });

  function clearAnswer() {
    if (confirm('Are you sure you want to clear this answer?')) {
      document.getElementById('response').value = '';
      document.getElementById('answer-form').submit();
    }
  }

  function toggleQuestionEdit() {
    const display = document.querySelector('.question-display');
    const editForm = document.getElementById('question-edit-form');
    
    if (editForm.style.display === 'none') {
      display.style.display = 'none';
      editForm.style.display = 'block';
      document.getElementById('question').focus();
    } else {
      display.style.display = 'block';
      editForm.style.display = 'none';
    }
  }

  // Filter functionality
  function toggleAnsweredQuestions() {
    const checkbox = document.getElementById('hideAnswered');
    const isHidden = checkbox.checked;
    const questionItems = document.querySelectorAll('.question-item');
    
    questionItems.forEach(item => {
      const link = item.querySelector('.question-link');
      const isAnswered = link.classList.contains('answered');
      
      if (isHidden && isAnswered) {
        item.classList.add('hidden');
      } else {
        item.classList.remove('hidden');
      }
    });
    
    // Save preference to localStorage
    localStorage.setItem('hideAnsweredQuestions', isHidden);
    
    // Update progress indicator text to reflect filtered view
    updateProgressText();
  }
  
  function updateProgressText() {
    const checkbox = document.getElementById('hideAnswered');
    const isHidden = checkbox.checked;
    const progressText = document.querySelector('.progress-text');
    const totalQuestions = {{ total }};
    const answeredQuestions = {{ answered_count }};
    
    if (isHidden) {
      const unansweredQuestions = totalQuestions - answeredQuestions;
      progressText.textContent = `Showing ${unansweredQuestions} unanswered of ${totalQuestions} total`;
    } else {
      progressText.textContent = `${answeredQuestions} of ${totalQuestions} answered`;
    }
  }

  // Initialize filter state on page load
  document.addEventListener('DOMContentLoaded', function() {
    const savedState = localStorage.getItem('hideAnsweredQuestions');
    if (savedState === 'true') {
      document.getElementById('hideAnswered').checked = true;
      toggleAnsweredQuestions();
    }
  });
</script>
{% endblock %}
